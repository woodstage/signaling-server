<html>

<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.slim.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/16.0.0/umd/react.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/16.0.0/umd/react-dom.development.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/create-react-class@15.6.2/create-react-class.js"></script>
  <style>
    .online {
      color: green;
    }

    .offline {
      color: grey;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <div id="user-list"></div>
  <video autoplay id="my-video"></video>
  <video autoplay id="received-video"></video>
  <script>
    Notification.requestPermission().then( (result) => {
      console.log(result);
    });

    function createConnection() {
      return new RTCPeerConnection({
        iceServers: [
          {
            url: "stun:stun.l.google.com:19302"
          }
        ]
      });
    }

    function exchangeCandidates(socket, connection, to) {
      socket.on("candidate", message => {
        console.log("got candidate ", JSON.stringify(message));
        connection.addIceCandidate(new RTCIceCandidate({ candidate: message.data }));
      });
      connection.onicecandidate = (event) => {
        console.log('candidate event:', event);
        if (event.candidate) {
          const msg = {
            from: socket.id,
            to,
            data: event.candidate.candidate
          };
          console.log("send candidate: ", JSON.stringify(msg));
          socket.emit("candidate", msg);
        } else {
          console.log('End of candidates.');
        }
      };
    }

  </script>
  <script type="text/babel">
    const UserList = createReactClass({
        handleUserClick(user) {
          this.props.onUserSelect(user);
        },

        render() {
          return <div>
              {Object.values(this.props.users).map((user, index) => {
                return <div className={user.socketId ? "online" : "offline"} key={index} onClick={this.handleUserClick.bind(this, user)}>{user.name}</div>;
              })}
            </div>
        }
      })

    const App = createReactClass({
      getInitialState() {
        return {
          users: {}
        };
      },

      componentDidMount() {
        this.socket = io(window.location.href);
        this.socket.on('connect', () => {
          console.log(this.socket.id); // 'G5p5...'
        });
        this.socket.on('disconnect',  () => { });
        this.socket.on("user-list", data => {
          console.log("user list: ", data);
          this.setState({users: data});
        });
        this.socket.on("offer", message => {
          console.log("got offer: ", JSON.stringify(message));
          const connection = createConnection();
          connection.onaddstream = (event) => {
            const url = URL.createObjectURL(event.stream);
            console.log("video url: ", url);
            document.getElementById("received-video").src = url;
          }

          connection.ondatachannel = (event) => {
            console.log("data channel opened.");
            const channel = event.channel;
            this.setState({
              [message.from]: {connection, channel}
            }, () => {
              console.log("state: ", this.state)
            });
            channel.onmessage = (event) => {
              console.log("got message: ", event.data);
              new Notification("from " + Object.values(this.state.users).find(user => user.socketId === message.from).name + ": " + event.data);
            }
          }

          connection.onicecandidate = (event) => {
            console.log('candidate event:', event);
            if (event.candidate) {
              const msg = {
                from: this.socket.id,
                to: message.from,
                data: event.candidate.candidate
              };
              console.log("send candidate: ", JSON.stringify(msg));
              this.socket.emit("candidate", msg);
            } else {
              console.log('End of candidates.');
            }
          };

          connection.setRemoteDescription(new RTCSessionDescription(message.data)).then(() => {
            connection.createAnswer({
              OfferToReceiveAudio: true,
              OfferToReceiveVideo : true
            }).then(answer => {
              connection.setLocalDescription(answer).then(() => {
                const msg = {from: message.to, to: message.from, data: answer};
                console.log("send answer: ", JSON.stringify(msg));
                this.socket.emit("answer", msg);
              });
            })
          });

          this.socket.on("answer", message => {
            console.log("got answer ", JSON.stringify(message));
            connection.setRemoteDescription(new RTCSessionDescription(message.data))
              .then(() => {
                console.log('Set remote desc successfully.');
              });
          });

          this.socket.on("candidate", message => {
            console.log("got candidate ", JSON.stringify(message));
            connection.addIceCandidate(new RTCIceCandidate({ candidate: message.data }));
          });
        });
      },

      onUserSelect(user) {
        const connection = createConnection();
        
        navigator.mediaDevices.getUserMedia({video:true, audio:true})
        .then((stream) => {
          /* use the stream */
          const url = URL.createObjectURL(stream);
          document.getElementById("my-video").src = url;
          connection.addStream(stream);

          connection.createOffer({ OfferToReceiveAudio: true, OfferToReceiveVideo : true }).then(offer => {
            connection.setLocalDescription(offer).then(() => {
            const message = {from: this.socket.id, to: user.socketId, data: offer};
            console.log("send offer: ", JSON.stringify(message))
            this.socket.emit("offer", message);
          });
        });

        })
        .catch(function(err) {
          /* handle the error */
        });

        // const channel = connection.createDataChannel("data-channel");
        // channel.onopen = (event) => {
        //   console.log("data channel opened.");
        //   this.setState({
        //     [user.socketId]: {connection, channel}
        //   }, () => {
        //     console.log("state: ", this.state)});
        //     const message = prompt("put a message");
        //     channel.send(message);
        // }
        // channel.onmessage = (event) => {
        //   console.log("got message: ", event.data);
        //   new Notification("from " + user.socketId + ": " + event.data);
        // }

        connection.onicecandidate = (event) => {
          console.log('candidate event:', event);
          if (event.candidate) {
            const msg = {
              from: this.socket.id,
              to: user.socketId,
              data: event.candidate.candidate
            };
            console.log("send candidate: ", JSON.stringify(msg));
            this.socket.emit("candidate", msg);
          } else {
            console.log('End of candidates.');
          }
        };

        connection.createOffer({ OfferToReceiveAudio: true, OfferToReceiveVideo : true }).then(offer => {
            connection.setLocalDescription(offer).then(() => {
            const message = {from: this.socket.id, to: user.socketId, data: offer};
            console.log("send offer: ", JSON.stringify(message))
            this.socket.emit("offer", message);
          });
        });

        this.socket.on("answer", message => {
          console.log("got answer ", JSON.stringify(message));
          connection.setRemoteDescription(new RTCSessionDescription(message.data))
            .then(() => {
              console.log('Set remote desc successfully.');
            });
        });

        
      },

      render() {
        return <div><UserList users={this.state.users} onUserSelect={user => this.onUserSelect(user)}/></div>
      }
    })

    
    ReactDOM.render(<App/>, document.getElementById("root"));
  </script>
</body>

</html>